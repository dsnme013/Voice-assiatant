<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ElevenLabs Voice Assistant</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
        }
        
        .status-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .status-row:last-child {
            margin-bottom: 0;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .status-connected { background: #10b981; }
        .status-connecting { background: #f59e0b; animation: pulse 2s infinite; }
        .status-disconnected { background: #ef4444; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            margin: 30px 0;
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            min-width: 140px;
        }
        
        .btn:hover:not(:disabled) {
            background: #4338ca;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .widget-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin: 25px 0;
            border: 2px solid #e5e7eb;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .placeholder {
            color: #6b7280;
            text-align: center;
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid;
        }
        
        .alert-error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .alert-warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        
        .alert-info {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .debug-section {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
        }
        
        .debug-entry {
            margin-bottom: 5px;
            word-break: break-all;
        }
        
        .timestamp {
            color: #64748b;
            margin-right: 8px;
        }
        
        .log-info { color: #3b82f6; }
        .log-success { color: #10b981; }
        .log-warning { color: #f59e0b; }
        .log-error { color: #ef4444; }
        
        .hidden {
            display: none !important;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
        
        /* ElevenLabs widget custom styling */
        elevenlabs-convai {
            width: 100% !important;
            max-width: 400px !important;
            margin: 0 auto !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Voice Assistant</h1>
            <p>Simple and reliable voice communication</p>
        </div>
        
        <!-- Status -->
        <div class="status-card">
            <div class="status-row">
                <span id="statusDot" class="status-dot status-disconnected"></span>
                <span id="statusText">Initializing...</span>
            </div>
        </div>
        
        <!-- Alerts -->
        <div id="alertContainer"></div>
        
        <!-- Controls -->
        <div class="controls">
            <button id="startBtn" class="btn" onclick="startVoice()" disabled>
                <span id="startBtnText">Loading...</span>
            </button>
            <button id="stopBtn" class="btn btn-danger" onclick="stopVoice()" disabled>
                Stop Voice
            </button>
        </div>
        
        <!-- Widget Container -->
        <div class="widget-container" id="widgetContainer">
            <div class="placeholder">
                <p>Voice assistant will appear here</p>
                <p style="font-size: 0.9rem; margin-top: 8px;">Click "Start Voice" to begin</p>
            </div>
        </div>
        
        <!-- Debug Console -->
        <div class="debug-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <strong>Debug Log</strong>
                <button onclick="clearLog()" style="background: #374151; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                    Clear
                </button>
            </div>
            <div id="debugLog"></div>
        </div>
    </div>

    <!-- ElevenLabs Script -->
    <script src="https://unpkg.com/@elevenlabs/convai-widget-embed" async type="text/javascript" onload="onScriptLoaded()"></script>
    
    <script>
        class SimpleVoiceAssistant {
            constructor() {
                // IMPORTANT: Replace with your actual agent ID
                this.agentId = "agent_2801k5dwcesde948vmng3bxfbrds";
                
                this.isActive = false;
                this.widget = null;
                this.scriptLoaded = false;
                
                this.init();
            }
            
            init() {
                this.log("Voice Assistant initializing...", 'info');
                this.updateStatus('connecting', 'Checking system...');
                
                // Basic compatibility check
                this.checkBasicCompatibility();
            }
            
            checkBasicCompatibility() {
                const issues = [];
                
                // Check HTTPS
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    issues.push({
                        type: 'error',
                        title: 'HTTPS Required',
                        message: 'Voice features require HTTPS connection for microphone access.'
                    });
                }
                
                // Check WebRTC
                if (!window.RTCPeerConnection && !window.webkitRTCPeerConnection) {
                    issues.push({
                        type: 'error',
                        title: 'WebRTC Not Supported',
                        message: 'Your browser does not support WebRTC. Please use Chrome, Firefox, Safari, or Edge.'
                    });
                }
                
                // Check getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    issues.push({
                        type: 'error',
                        title: 'Microphone Access Not Available',
                        message: 'Your browser does not support microphone access.'
                    });
                }
                
                // Show issues if any
                if (issues.length > 0) {
                    this.showAlerts(issues);
                    this.updateStatus('disconnected', 'System check failed');
                    this.log("Compatibility issues found", 'error');
                } else {
                    this.updateStatus('disconnected', 'Ready - waiting for script...');
                    this.log("Basic compatibility check passed", 'success');
                }
                
                this.updateControls();
            }
            
            onScriptLoaded() {
                this.scriptLoaded = true;
                this.log("ElevenLabs script loaded", 'success');
                
                if (this.canStart()) {
                    this.updateStatus('disconnected', 'Ready to start');
                    document.getElementById('startBtnText').textContent = 'Start Voice';
                    document.getElementById('startBtn').disabled = false;
                } else {
                    this.updateStatus('disconnected', 'Cannot start - check issues above');
                    document.getElementById('startBtnText').textContent = 'Cannot Start';
                }
            }
            
            canStart() {
                return this.scriptLoaded && 
                       (location.protocol === 'https:' || location.hostname === 'localhost') &&
                       window.RTCPeerConnection &&
                       navigator.mediaDevices;
            }
            
            async startVoice() {
                if (this.isActive) return;
                
                this.log("Starting voice assistant...", 'info');
                this.updateStatus('connecting', 'Requesting microphone permission...');
                
                try {
                    // Request microphone permission first
                    await this.requestMicrophone();
                    this.log("Microphone permission granted", 'success');
                    
                    // Create widget
                    await this.createWidget();
                    
                } catch (error) {
                    this.log(`Failed to start: ${error.message}`, 'error');
                    this.updateStatus('disconnected', 'Failed to start');
                    this.showAlert('error', 'Connection Failed', error.message);
                }
            }
            
            async requestMicrophone() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    return true;
                } catch (error) {
                    throw new Error(`Microphone access denied: ${error.message}`);
                }
            }
            
            async createWidget() {
                const container = document.getElementById('widgetContainer');
                container.innerHTML = '';
                
                // Create widget
                const widget = document.createElement('elevenlabs-convai');
                widget.setAttribute('agent-id', this.agentId);
                
                // Use the most compatible format
                widget.setAttribute('audio-format', 'pcm_44100');
                
                // Event listeners
                widget.addEventListener('connect', () => {
                    this.log("Widget connected successfully", 'success');
                    this.updateStatus('connected', 'Connected - speak now!');
                    this.isActive = true;
                    this.updateControls();
                });
                
                widget.addEventListener('disconnect', () => {
                    this.log("Widget disconnected", 'warning');
                    this.handleDisconnection();
                });
                
                widget.addEventListener('error', (event) => {
                    this.log(`Widget error: ${JSON.stringify(event.detail)}`, 'error');
                    this.handleError(event.detail);
                });
                
                // Add timeout
                const timeout = setTimeout(() => {
                    this.log("Connection timeout - please check your agent ID", 'error');
                    this.handleError("Connection timeout. Please verify your agent ID is correct and the agent is active in ElevenLabs dashboard.");
                }, 45000);
                
                widget.addEventListener('connect', () => clearTimeout(timeout));
                
                container.appendChild(widget);
                this.widget = widget;
                
                this.updateStatus('connecting', 'Connecting to voice service...');
                this.log("Widget created, attempting connection...", 'info');
            }
            
            stopVoice() {
                this.log("Stopping voice assistant...", 'info');
                
                if (this.widget) {
                    try {
                        if (typeof this.widget.endConversation === 'function') {
                            this.widget.endConversation();
                        }
                        this.widget.remove();
                    } catch (error) {
                        this.log(`Error stopping widget: ${error.message}`, 'warning');
                    }
                    this.widget = null;
                }
                
                const container = document.getElementById('widgetContainer');
                container.innerHTML = '<div class="placeholder"><p>Voice assistant stopped</p><p style="font-size: 0.9rem; margin-top: 8px;">Click "Start Voice" to begin again</p></div>';
                
                this.isActive = false;
                this.updateStatus('disconnected', 'Stopped');
                this.updateControls();
            }
            
            handleDisconnection() {
                this.isActive = false;
                this.updateStatus('disconnected', 'Disconnected');
                this.updateControls();
                
                const container = document.getElementById('widgetContainer');
                container.innerHTML = '<div class="placeholder"><p>Connection lost</p><p style="font-size: 0.9rem; margin-top: 8px;">Click "Start Voice" to reconnect</p></div>';
            }
            
            handleError(error) {
                this.log(`Error: ${error}`, 'error');
                this.updateStatus('disconnected', 'Connection failed');
                this.isActive = false;
                this.updateControls();
                
                let message = error;
                let suggestions = [];
                
                if (typeof error === 'string') {
                    if (error.includes('timeout') || error.includes('Connection timeout')) {
                        message = "Connection timeout - this usually means the agent ID is incorrect or the agent is not active.";
                        suggestions = [
                            'Verify your agent ID is correct in the HTML file',
                            'Check that your agent is active in ElevenLabs dashboard',
                            'Ensure your agent is configured as a public agent',
                            'Try refreshing the page and attempting again'
                        ];
                    } else if (error.includes('permission') || error.includes('microphone')) {
                        message = "Microphone access issue.";
                        suggestions = [
                            'Click the microphone icon in your browser address bar',
                            'Allow microphone access for this website',
                            'Check your browser settings for microphone permissions'
                        ];
                    }
                }
                
                this.showAlert('error', 'Connection Error', message, suggestions);
                
                const container = document.getElementById('widgetContainer');
                container.innerHTML = '<div class="placeholder"><p>Connection failed</p><p style="font-size: 0.9rem; margin-top: 8px;">Check the error above and try again</p></div>';
            }
            
            updateStatus(status, message) {
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                
                dot.className = `status-dot status-${status}`;
                text.textContent = message;
            }
            
            updateControls() {
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                startBtn.disabled = this.isActive || !this.canStart();
                stopBtn.disabled = !this.isActive;
            }
            
            showAlert(type, title, message, suggestions = []) {
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                
                let suggestionsHtml = '';
                if (suggestions.length > 0) {
                    suggestionsHtml = '<ul style="margin-top: 10px; margin-left: 20px;">' + 
                        suggestions.map(s => `<li>${s}</li>`).join('') + 
                        '</ul>';
                }
                
                alert.innerHTML = `
                    <h4 style="font-weight: 600; margin-bottom: 8px;">${title}</h4>
                    <p>${message}</p>
                    ${suggestionsHtml}
                `;
                
                container.appendChild(alert);
            }
            
            showAlerts(alerts) {
                const container = document.getElementById('alertContainer');
                container.innerHTML = '';
                alerts.forEach(alert => this.showAlert(alert.type, alert.title, alert.message));
            }
            
            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] ${message}`);
                
                const debugLog = document.getElementById('debugLog');
                const entry = document.createElement('div');
                entry.className = 'debug-entry';
                entry.innerHTML = `<span class="timestamp">[${timestamp}]</span><span class="log-${level}">${message}</span>`;
                
                debugLog.appendChild(entry);
                debugLog.scrollTop = debugLog.scrollHeight;
                
                // Keep only last 30 entries
                while (debugLog.children.length > 30) {
                    debugLog.removeChild(debugLog.firstChild);
                }
            }
        }
        
        // Global instance
        let assistant;
        
        // Global functions
        function startVoice() {
            if (assistant) assistant.startVoice();
        }
        
        function stopVoice() {
            if (assistant) assistant.stopVoice();
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function onScriptLoaded() {
            if (assistant) assistant.onScriptLoaded();
        }
        
        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            assistant = new SimpleVoiceAssistant();
        });
    </script>
</body>
</html>
